#!/usr/bin/env sh
set -eu

run_step() {
  label="$1"
  shift
  echo "husky > $label"
  "$@"
}

if ! command -v npm >/dev/null 2>&1; then
  echo "husky > npm이 없어 훅을 건너뜁니다." >&2
  exit 0
fi

run_step "lint" npm exec --yes eslint -- . --ext .js,.ts,.vue
run_step "type-check" npm exec --yes vue-tsc -- --noEmit -p tsconfig.app.json

staged_files="$(git diff --name-only --cached --diff-filter=ACMRTUXB | tr '\n' ' ')"
format_targets="$(printf "%s" "$staged_files" | tr ' ' '\n' | grep -E '\.(js|ts|vue|json|css|scss|cjs|mjs|html|md|yaml|yml)$' || true)"
if [ -n "$format_targets" ]; then
  # prettier는 공백으로 구분된 파일 목록을 받는다.
  run_step "format" npm exec --yes prettier -- --check $format_targets
else
  echo "husky > format: 포맷 검사 대상이 없습니다."
fi
